<template>
    <div class="main_box">
      <v-title>
        <li>
          <a href="#/surveyResults">调查结果统计</a>
        </li>
        <li class="active" slot="name">满意度调查</li>
      </v-title>
      <div class="export">
        <button class="btn btn-info" @click="exportEcharts">导出</button>
      </div>
      <div class="result_analyse">
        <!-- <div style="padding: 10px 20px;margin-bottom: 8px;">
            <input type="checkbox" @click="checkedAll" :checked="checkedFlag()">
        </div> -->
        <div class="subject" :id="item[0].questionNameType.questionnamevalId" v-for="(item,index) in SatisfactionInfo" v-show="!noDataShow">
            <!-- 左侧选项分析 -->
            <div class="subject_left">
                <div class="subject_left_title">
                    <input type="checkbox" @click.stop="stop" :value="item[0].questionNameType.questionnamevalId" v-model="questionId">
                    <label class="name" for="">第{{index+1}}题:{{item[0].questionNameType.questionNamemc}}({{item[0].questionNameType.questionNameTypemc}}题)</label>
                </div>
                <div class="tab" v-if="item[0].questionNameType.questionNameTypemc=='单选'">
                    <table class="table table-bordered">
                        <tbody>
                            <tr class="danxuan" v-for="item2 in item[0].data">
                                <td class="td1">{{item2.singleOpt}}</td>
                                <td class="td2">{{item2.singleOptTxt}}</td>
                                <td class="td3">{{item2.singleOptNum}}</td>
                                <td class="td4">{{item2.singleOptPer}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="tab" v-else-if="item[0].questionNameType.questionNameTypemc=='多选'">
                    <table class="table table-bordered">
                        <tbody>
                            <tr class="duoxuan" v-for="item2 in item[0].data">
                                <td class="td1">{{item2.singleOpt}}</td>
                                <td class="td2">{{item2.singleOptTxt}}</td>
                                <td class="td3">{{item2.singleOptPer}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="tab" v-else-if="item[0].questionNameType.questionNameTypemc=='填空,num'||item[0].questionNameType.questionNameTypemc=='填空,double'">
                    <table class="table table-bordered">
                      <tbody>
                        <tr class="tiankong1" v-for="item2 in item[0].data">
                            <td class="td1">{{item2.singleOptTxt}}</td>
                            <td class="td2">{{item2.singleOptNum}}</td>
                            <td class="td3">{{item2.singleOptPer}}</td>
                        </tr>
                      </tbody>
                    </table>
                </div>
                <div class="tab" v-else-if="item[0].questionNameType.questionNameTypemc=='填空,txt'">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>答题者</th>
                                <th>答案</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="tiankong2" v-for="item2 in item[0].data">
                                <td class="userNames">{{item2.userNames}}</td>
                                <td class="titleAnswer">{{item2.titleAnswer}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
             
            <div class="subject_right">
                <ul class="subject_right_ul"
                v-if="item[0].questionNameType.questionNameTypemc=='单选'
                ||item[0].questionNameType.questionNameTypemc=='填空,num'
                ||item[0].questionNameType.questionNameTypemc=='填空,double'">
                    <li v-for="(item,index) in echarts" :class='{active:index==active}'>
                    {{item}}
                    </li>
                </ul>
                <div 
                :id="'echarts'+index" 
                style="height: 255px;width: 600px;margin: 0 auto;" 
                v-if="item[0].questionNameType.questionNameTypemc=='单选'
                ||item[0].questionNameType.questionNameTypemc=='填空,num'
                ||item[0].questionNameType.questionNameTypemc=='填空,double'"></div>
            </div>
            <img src="static/down.png" style="float:right;" alt="">
        </div> 
        <dir v-show="noDataShow" style="text-align: center;font-size:24px;color: #1975b6;">
            暂无数据
        </dir>
      </div>
  </div>
</template>
<script>
import vTitle from "../views/vTitle";
// import Subject from "../views/Subject";
export default {
    data() {
        return {
            naireId:this.$route.query.id,
            nairName:this.$route.query.nairName,
            numbers:'1',
            questionName: [],
            SatisfactionInfo:[],       //满意度调查问卷数据
            answerCon:[],              //每个问题答案
            answerIndex:'0',           //答案对应的题目下标
            echarts:['饼状图','圆环图','柱状图','条形图'],
            echartsData:[],
            echartsDataX:[],
            echartsDataY:[],
            echartsLegend:[],
            active:0,
            questionId:[],
            all:[],
            imgUrl:'',
            noDataShow: false,
            noDatashow2: false,
            initTable: [],
            exportPicArray:[],
            singleCon:[],   //单选题选项
            multiCon:[],    //多选选项
            blankTxtCon:[],     //填空选项
            isCheckedAll:true
        }
    },
    components: { vTitle },
    mounted(){
        this.initSatisfaction();
        this.initClick()
    },
    methods: {
        initSatisfaction(){         //所有题目列表
            let param = new URLSearchParams()
            param.append('questionnaireId', this.naireId)     //问卷ID
            param.append('questionnaireName', this.nairName)   //问卷名称
            this.axios({
                method: 'post',
                url: 'questionnaireAnswer.do?InquireDetailss',
                async:false,    //或false,是否异步
                data: param,
            }).then(res=>{
                 for(var i=0;i<res.data.o.length;i++){
                    var name = res.data.o[i][0].questionNameType.questionNameTypemc
                    if(name == "单选"){
                        var singleOption = [];
                        for(var key in res.data.o[i][0].data){
                            singleOption.push(res.data.o[i][0].data[key])
                        }
                        res.data.o[i][0].data=[];
                        var echarts = []
                        for(var j=0;j<singleOption.length;j++){
                            res.data.o[i][0].data.push({
                                singleOpt:singleOption[j].split(':')[0],
                                singleOptTxt:singleOption[j].split(':')[1].split(',')[0],
                                singleOptNum:singleOption[j].split(':')[1].split(',')[1],
                                singleOptPer:singleOption[j].split(':')[1].split(',')[2]
                            })
                            echarts.push({
                                value:singleOption[j].split(':')[1].split(',')[2],
                                name:singleOption[j].split(':')[1].split(',')[0]
                            })
                        }
                        //this.cutEcharts(i,echarts,"echarts"+i)
                    }else if(name == "多选"){
                        var singleOption = [];
                        for(var key in res.data.o[i][0].data){
                            singleOption.push(res.data.o[i][0].data[key])
                        }
                        res.data.o[i][0].data=[];
                        for(var j=0;j<singleOption.length;j++){
                            res.data.o[i][0].data.push({
                                singleOpt:singleOption[j].split(':')[0],
                                singleOptTxt:singleOption[j].split(':')[1].split(',')[0],
                                singleOptPer:singleOption[j].split(':')[1].split(',')[1]
                            })
                        }
                    }else if(name=="填空,num"||name=="填空,double"){
                        var singleOption = [];
                        for(var key in res.data.o[i][0].data){
                            singleOption.push(res.data.o[i][0].data[key])
                        }
                        res.data.o[i][0].data=[];
                        for(var j=0;j<singleOption.length;j++){
                            res.data.o[i][0].data.push({
                                singleOptTxt:singleOption[j].split(',')[0],
                                singleOptNum:singleOption[j].split(',')[1],
                                singleOptPer:singleOption[j].split(',')[2]
                            })
                        }
                    }else {
                       var singleOption = [];
                       for(var t = 1; t < res.data.o[i].length;t++){
                           singleOption.push(res.data.o[i][t])
                       }
                       res.data.o[i][0].data=[];
                        for(var j=0;j<singleOption.length;j++){
                            res.data.o[i][0].data.push({
                                titleAnswer:singleOption[j].titleAnswer,
                                userNames:singleOption[j].userNames
                            })
                        }
                    }
                }
                this.SatisfactionInfo = res.data.o
            })
        }, 
        //answerDetail(questionName,numbers,arrayAll){    //当前查看的题目的选项
        answerDetail(){    //当前查看的题目的选项
            let param = new URLSearchParams()
            param.append('questionnaireId', this.naireId)
            // param.append('numbers', numbers)
            // param.append('questionName', questionName)
            param.append('questionnaireName', this.nairName)
            this.axios({
                method: 'post',
                url: 'questionnaireAnswer.do?InquireDetails',
                async:false,    //或false,是否异步
                data: param,
            }).then(res=>{
                console.log(res.data.o);
                var type = "";
                var arrType = res.data.two.split(',')
                if(arrType[0] == "多选"){
                    type = "多选"
                }else if(arrType[0] == "单选"){
                    type = "单选"
                }else {
                    if(arrType[1] == "num"){
                        type = "num"
                    }else if(arrType[1] == "text"){
                        type = "text"
                    }else if(arrType[1] == "double"){
                        type = "double"
                    }else {
                        type = "填空"
                    }
                }
                var listAnswer=[];
                this.answerCon = [];
                this.echartsData = [];
                this.echartsDataX = [];
                this.echartsDataY = [];
                this.initTable = []
                if(type == '单选' || type == "num" || type == 'double'){
                    var arr = [];  
                    var num;
                    if(res.data.o != null){
                        num = Object.keys(res.data.o).length;
                    }
                    var one,two,three,four,five;
                    switch(num){
                        case 1:
                        arr.push(res.data.o.onecontent)
                        break;
                        case 2:
                        arr.push(res.data.o.onecontent,res.data.o.twocontent)
                        break;
                        case 3:
                        arr.push(res.data.o.onecontent,res.data.o.twocontent,res.data.o.threecontent)
                        break;
                        case 4:
                        arr.push(res.data.o.onecontent,res.data.o.twocontent,res.data.o.threecontent,res.data.o.fourcontent)
                        break;
                        case 5:
                        arr.push(res.data.o.onecontent,res.data.o.twocontent,res.data.o.threecontent,res.data.o.fourcontent,res.data.o.fivecontent)
                        break;
                    }
                    for(var i=0;i<arr.length;i++){
                        this.answerCon.push(arr[i].split(',').join(" "));
                    }
                    if(this.answerCon.length>0) listAnswer=this.answerCon;
                    var arr2;
                    console.log(arr);
                    for(var i=0;i<arr.length;i++){
                        arr2 = arr[i].split(',');
                        this.echartsData.push({
                            //value: arr2[1].split("/")[0],
                            value: arr2[2],
                            name: arr2[0].split(":")[1]
                        })
                        this.echartsDataX.push(arr2[0].split(":")[1])
                        this.echartsDataY.push(arr2[2])
                    }
                }else if(type == '多选'){
                    var arr = [];  
                    var num;
                    if(res.data.o != null){
                        num = Object.keys(res.data.o).length;
                    }
                    var one,two,three,four,five;
                    switch(num){
                        case 1:
                        arr.push(res.data.o.onecontent)
                        break;
                        case 2:
                        arr.push(res.data.o.onecontent,res.data.o.twocontent)
                        break;
                        case 3:
                        arr.push(res.data.o.onecontent,res.data.o.twocontent,res.data.o.threecontent)
                        break;
                        case 4:
                        arr.push(res.data.o.onecontent,res.data.o.twocontent,res.data.o.threecontent,res.data.o.fourcontent)
                        break;
                        case 5:
                        arr.push(res.data.o.onecontent,res.data.o.twocontent,res.data.o.threecontent,res.data.o.fourcontent,res.data.o.fivecontent)
                        break;
                    }
                    for(var i=0;i<arr.length;i++){
                        var temporary = arr[i].split(',');
                        this.answerCon.push({'multiSelOpt':arr[i].split(':')[0],'multiSelCon':temporary[0].split(":")[1],'multiSelNum':arr[i].split(',')[1]})
                        // this.multiSelOpt.push(arr[i].split(':')[0]);
                        // this.multiSelNum.push(arr[i].split(',')[1]);
                        //this.multiSelCon.push(temporary[0].split(":")[0]);
                    }
                    // multiSel = 
                }else{
                    console.log(res.data.o)
                    if(res.data.o == "" || res.data.o == null){
                        this.initTable = []
                        this.noDatashow2 = true
                    }else {
                        this.initTable = res.data.o
                        this.noDatashow2 = false
                    }
                }
                this.answerIndex = res.data.s
                setTimeout(() => {
                    this.cutEcharts(0);
                    // if(trueOrFalse){
                    //     arrayAll.push({
                    //         index: numbers,
                    //         questionName:questionName,
                    //         answer:listAnswer,
                    //         imgUrl:this.imgUrl,
                    //         type: type
                    //     }) 
                    // }       
                }, 300);
            })
        },
        cutEcharts(index,echartsData,id){       //当前查看的题目的echarts加载
            // 基于准备好的dom，初始化echarts实例
            console.log(echartsData)
            var myChart = this.$echarts.init(document.getElementById(id));
            console.log(myChart)
            if(index == 0){    
                myChart.setOption({
                    tooltip : {
                        trigger: 'item',
                        formatter: "{b} : {c}"
                    },
                    xAxis: { show:false },
                    yAxis: { show:false },
                    series : [{
                        type: 'pie',
                        radius : '55%',
                        data:echartsData
                    }]
                });
            }else if(index == 1){
                myChart.setOption({
                    tooltip : {
                        trigger: 'item',
                        formatter: "{b} : {c} ({d}%)"
                    },
                    xAxis: { show:false },
                    yAxis: { show:false },
                    series : [{
                        type: 'pie',
                        radius: ['50%', '70%'],
                        avoidLabelOverlap: false,
                        data:echartsData
                    }]
                });
            }
            // else if(index == 2){
            //     myChart.setOption({
            //     xAxis: {
            //         show:true,
            //         type: 'category',
            //         data: this.echartsDataX
            //     },
            //     yAxis: { show:true,type: 'value' },
            //     series: [{
            //         data: this.echartsDataY,
            //         type: 'bar'
            //     }]
            //     });
            // }else if(index == 3){
            //     myChart.setOption({
            //     xAxis: { type: 'value' },
            //     yAxis: {
            //         type: 'category',
            //         data: this.echartsDataX
            //     },
            //     series: [{
            //         data: this.echartsDataY,
            //         type: 'bar'
            //     }]
            //     });
            // }
            this.imgUrl = " ";
            var img = new Image();
            img.src = myChart.getDataURL({
                pixelRatio: 2,
                backgroundColor: '#fff'
            });
            this.imgUrl = img.src   
            this.active = index   
        },
        exportEcharts(){
            if(this.questionId == ""){  //页面无数据
                this.$dialog.alert("请选择数据再进行导出")
            }else{   //页面有数据ss
                this.all = []
                for(var i = 0;i<this.questionId.length;i++){
                    var name = $('#'+this.questionId[i]+' .subject_left .subject_left_title').find('.name').text()
                    var name2 = name.split(':')[1]
                    var questionNamemc = name2.split('(')[0]
                    var name3 = name2.split('(')[1]
                    var questionNameTypemc = name3.split(')')[0]
                    var txt = [];
                    if(questionNameTypemc == "单选题"){
                        for(var j = 0;j<$('#'+this.questionId[i]).find('.tab tr.danxuan').length;j++){
                            //txt.push($('#'+this.questionId[i]).find('.tab tr.danxuan').eq(j).find('td').text())
                            var td = ""
                            td += $('#'+this.questionId[i]).find('.tab tr.danxuan').eq(j).find('td.td1').text()+',';
                            td += $('#'+this.questionId[i]).find('.tab tr.danxuan').eq(j).find('td.td2').text()+',';
                            td += $('#'+this.questionId[i]).find('.tab tr.danxuan').eq(j).find('td.td3').text()+',';
                            td += $('#'+this.questionId[i]).find('.tab tr.danxuan').eq(j).find('td.td4').text()
                            txt.push(td)
                        }
                    }else if(questionNameTypemc == "多选题"){
                        for(var j = 0;j<$('#'+this.questionId[i]).find('.tab tr.duoxuan').length;j++){
                            var td = ""
                            td += $('#'+this.questionId[i]).find('.tab tr.duoxuan').eq(j).find('td.td1').text()+',';
                            td += $('#'+this.questionId[i]).find('.tab tr.duoxuan').eq(j).find('td.td2').text()+',';
                            td += $('#'+this.questionId[i]).find('.tab tr.duoxuan').eq(j).find('td.td3').text()
                            txt.push(td)
                        }
                    }else if(questionNameTypemc == "填空,double题" || questionNameTypemc=="填空,num题"){
                         for(var j = 0;j<$('#'+this.questionId[i]).find('.tab tr.tiankong1').length;j++){
                            var td = ""
                            td += $('#'+this.questionId[i]).find('.tab tr.tiankong1').eq(j).find('td.td1').text()+',';
                            td += $('#'+this.questionId[i]).find('.tab tr.tiankong1').eq(j).find('td.td2').text()+',';
                            td += $('#'+this.questionId[i]).find('.tab tr.tiankong1').eq(j).find('td.td3').text()
                            txt.push(td)
                        }
                    }else {
                        for(var j = 0;j<$('#'+this.questionId[i]).find('.tab tr.tiankong2').length;j++){
                            var obj = new Object()
                            obj.titleAnswer = $('#'+this.questionId[i]).find('.tab tr.tiankong2').eq(j).find('td.titleAnswer').text()
                            obj.userNames = $('#'+this.questionId[i]).find('.tab tr.tiankong2').eq(j).find('td.userNames').text()
                            txt.push(obj)
                        }
                    }
                    var result = {
                        'questionNamemc':questionNamemc,
                        'questionNameTypemc':questionNameTypemc,
                        'data':txt
                    }
                    this.all.push(result)
                }
                console.log(this.all)
                let param = new URLSearchParams()
                param.append('question',this.nairName)
                param.append('resultArray',JSON.stringify(this.all))
                this.axios({
                    method: 'post',
                    url: 'questionnaireAnswer.do?publicExport',         
                    data: param,
                }).then(res=>{
                    console.log(res.data.o);   
                    if(res.data.e == 0){        
                        window.location.href = "questionnaireAnswer.do?download&filePath="+res.data.o    
                    }else if(res.data.e == 1){
                        this.$dialog.alert("导出失败")
                    }
                })
            } 
        },
        initClick(){
            $(document).off("click").on("click",".subject",function() {
                $(this).find('div.tab').slideToggle()
                $(this).find('div.subject_right').slideToggle()
            });
        },
        stop(){
            console.log('阻止事件冒泡')
        }
    }
};
</script>
<style scoped>
.main_box {
  position: relative;
}
.export {
  position: absolute;
  top: 4px;
  right: 2%;
}
.result_analyse {
  width: 96%;
  margin: 0 auto;
}
.subject{
    background: #fff;
    padding: 10px 20px;
    /* border: 1px solid #BBBBBB; */
    margin-bottom: 8px;
    cursor: pointer;
}
.subject_left{
    width: 40%;
}
.subject_right{
  width: 55%;
}
.subject_left img{
  float: right;
}
.subject_left_title{
    padding: 10px 0;
    color: #1975b6;
}
.subject_left_title label {
    cursor: pointer;
}
.subject_left_answer{
    margin-left: 20px;
}
.subject_left_answer li{
    line-height: 50px;
}
.subject_left,.subject_right{
    display: inline-block;
    vertical-align: top;
}
.subject_right_ul{
    display: block;
    width: 255px;
    margin: 0 auto;
} 
.subject_right_ul:after{
    content: '';
    display: block;
    clear: both;
}
.subject_right_ul li{
    float: left;
    border: 1px solid #63B4EC;
    border-radius: 3px;
    padding: 3px 10px;
    cursor: pointer;
}
.subject_right_ul li.active {
  border: none;
  background: #63B4EC;
  color: #fff;
}
.echarts{
    border: 1px solid #ddd;
    margin-top: 30px;
}
</style>